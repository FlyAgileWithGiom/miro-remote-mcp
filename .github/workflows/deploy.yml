name: Deploy (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (dev or production)'
        required: true
        type: string
      version:
        description: 'Version to deploy'
        required: false
        type: string
        default: ''
      log_retention_days:
        description: 'Days to retain deployment logs'
        required: false
        type: number
        default: 14
      BASE_URI:
        description: 'Base URI for the deployment'
        required: true
        type: string
    secrets:
      SSH_PRIVATE_KEY:
        required: true
      SERVER_HOST:
        required: true
      MIRO_CLIENT_ID_B64:
        required: true
      MIRO_CLIENT_SECRET_B64:
        required: true

env:
  CI: "true"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version || github.ref }}

      - name: Get version
        id: version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION="${{ github.ref_name }}"
          elif [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="$(git rev-parse --short HEAD)"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Deploying version: ${VERSION} to ${{ inputs.environment }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Create deployment package
        run: |
          tar czf miro-mcp-deploy.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.env*' \
            --exclude='config' \
            --exclude='scripts' \
            dist \
            package.json \
            package-lock.json \
            docker-compose.yml \
            Dockerfile

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

          # Start SSH agent and add key
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa

          # Test connection
          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} "echo 'SSH connection successful'"

      - name: Deploy
        env:
          MIRO_CLIENT_ID_B64: ${{ secrets.MIRO_CLIENT_ID_B64 }}
          MIRO_CLIENT_SECRET_B64: ${{ secrets.MIRO_CLIENT_SECRET_B64 }}
          BASE_URI: ${{ inputs.BASE_URI }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          VERSION: ${{ steps.version.outputs.version }}
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          DEPLOY_PATH="/opt/miro-mcp"

          # Upload package
          echo "Uploading package to $SERVER_HOST:$DEPLOY_PATH..."
          ssh root@$SERVER_HOST "mkdir -p $DEPLOY_PATH"
          scp miro-mcp-deploy.tar.gz root@$SERVER_HOST:$DEPLOY_PATH/

          # Deploy on server
          echo "Deploying on server..."
          ssh root@$SERVER_HOST bash << 'REMOTE_EOF'
          set -e
          cd /opt/miro-mcp

          # Clean and extract
          echo "Cleaning old deployment..."
          find . -mindepth 1 -maxdepth 1 ! -name 'data' ! -name 'miro-mcp-deploy.tar.gz' -exec rm -rf {} + 2>&1 || true

          echo "Extracting..."
          tar xzf miro-mcp-deploy.tar.gz
          rm miro-mcp-deploy.tar.gz

          # Generate .env
          echo "Generating .env..."
          cat > .env << ENV_EOF
          # $ENVIRONMENT Environment - Generated by GitHub Actions
          NODE_ENV=production
          PORT=3000
          BASE_URI=$BASE_URI
          MIRO_CLIENT_ID_B64=$MIRO_CLIENT_ID_B64
          MIRO_CLIENT_SECRET_B64=$MIRO_CLIENT_SECRET_B64
          # Tokens are generated via /oauth/authorize and stored in /data/tokens.json
          ENV_EOF

          # Ensure ingress network exists
          echo "Checking ingress network..."
          docker network create ingress 2>/dev/null || true

          # Stop old containers
          echo "Stopping old containers..."
          docker compose down 2>/dev/null || true

          # Build and start
          echo "Building Docker image..."
          docker compose build

          echo "Starting service..."
          docker compose up -d

          # Wait
          sleep 5

          echo ""
          echo "Container status:"
          docker compose ps
          REMOTE_EOF
        continue-on-error: true

      - name: Save deployment log
        if: always()
        run: echo "Deployment completed for ${{ inputs.environment }}" > deploy.log

      - name: Upload deployment logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-${{ inputs.environment }}
          path: deploy.log
          retention-days: ${{ inputs.log_retention_days }}

      - name: Verify deployment
        run: |
          sleep 5
          if ! ssh root@${{ secrets.SERVER_HOST }} "docker ps | grep -q miro-mcp"; then
            echo "Error: miro-mcp container not running!"
            ssh root@${{ secrets.SERVER_HOST }} "cd /opt/miro-mcp && docker compose logs"
            exit 1
          fi
          echo "âœ… Container is running"

      - name: Deployment summary
        run: |
          echo "============================================"
          echo "DEPLOYMENT SUCCESSFUL"
          echo "Environment: ${{ inputs.environment }}"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Server: ${{ secrets.SERVER_HOST }}"
          echo "============================================"
